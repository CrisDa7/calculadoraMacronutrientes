<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CRISS FITT</title>
<link rel="icon" href="logo.png" type="image/png" />

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        brand: {50:'#e9f0ff',100:'#d7e5ff',200:'#b4ceff',300:'#8cb3ff',400:'#5e94ff',500:'#3a7cff',600:'#2c66e6',700:'#214fc0',800:'#1b419a',900:'#173a83'}
      }
    }
  }
}
</script>
<style>
  :root{
    --control-h: 44px;
    --radius: 12px;
  }

  /* Fondo + overlay */
  body{
    background:
      radial-gradient(1200px 500px at 50% -10%, rgba(58,124,255,.18), transparent 55%),
      linear-gradient(180deg, rgba(6,8,12,.65), rgba(8,10,14,.78)),
      url('yo.jpg') center / cover fixed no-repeat;
    color:#e9edf3; min-height:100vh;
  }

  /* Cards */
  .card{
    border:1px solid rgba(255,255,255,.14);
    background:rgba(20,22,26,.34);
    border-radius:16px;
    box-shadow: 0 14px 34px rgba(0,0,0,.32);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  /* Controles */
  .control{ height:var(--control-h); min-height:var(--control-h); border-radius:var(--radius); font-size:14px; }
  .field{
    width:100%; background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.18);
    padding:0 .9rem; color:#e6edf8; outline:none;
    transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .field:focus{
    border-color:rgba(94,148,255,.6);
    box-shadow:0 0 0 3px rgba(94,148,255,.24);
    background:rgba(255,255,255,.12);
  }

  .select-wrap{ position:relative; }
  .select-wrap::after{
    content:"▾"; position:absolute; right:.7rem; top:50%; transform:translateY(-50%);
    color:#a7c0ff; font-size:14px; pointer-events:none;
  }
  select.field{ appearance:none; padding-right:2rem; color-scheme: dark; }
  select.field option{ background:#0b0c10; color:#e5e7eb; }

  /* Botones */
  .btn{
    height:var(--control-h); min-height:var(--control-h);
    border-radius:var(--radius);
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.10);
    padding:0 1rem; font-weight:600; letter-spacing:.2px; transition:.18s ease;
  }
  .btn:hover{ background:rgba(255,255,255,.16); }
  .btn-primary{ background:linear-gradient(180deg,#3a7cff,#2c66e6); border-color:#2c66e6; color:#fff; }
  .btn-primary:hover{ filter:brightness(1.05); }

  /* Modal */
  .modal-bg{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:1rem;
    background:rgba(0,0,0,.72); opacity:0; visibility:hidden; pointer-events:none;
    transition:opacity .22s ease, visibility .22s ease; z-index:50;
  }
  .modal-bg.open{ opacity:1; visibility:visible; pointer-events:auto; }
  .modal{
    width:96%; max-width:760px; border-radius:18px;
    border:1px solid rgba(255,255,255,.14); background:#0b0b0c;
    transform:translateY(16px) scale(.98); opacity:0;
    transition:transform .26s ease, opacity .26s ease;
    max-height:80vh; display:flex; flex-direction:column;
  }
  .modal-bg.open .modal{ transform:translateY(0) scale(1); opacity:1; }
  .modal-header{ padding:14px 18px; border-bottom:1px solid rgba(255,255,255,.08); }
  .modal-body{
    padding:16px 18px;
    overflow-y:auto; overscroll-behavior:contain;
    scroll-behavior:smooth;
  }

  /* Panel negro con halo azul */
  .panel-base{ border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.05); border:1px solid rgba(94,148,255,.28); }
  .panel-black{
    background:
      radial-gradient(1200px 400px at 50% -10%, rgba(58,124,255,.10), transparent 60%),
      linear-gradient(135deg, rgba(12,14,18,.98), rgba(10,12,16,.98));
  }

  table{width:100%; border-collapse:separate; border-spacing:0 .5rem}
  td,th{padding:.45rem .6rem}
  th{font-size:.78rem; color:#a9b7c7; text-align:left}
</style>
</head>
<body class="selection:bg-brand-500/30">
  <!-- ===== Header ===== -->
  <header class="sticky top-0 z-10 bg-black/35 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-center gap-4">
      <img src="logo.png" alt="CRISS FITT" class="h-14 sm:h-16 md:h-20 w-auto rounded-md shadow" />
      <div class="text-center leading-tight">
        <div class="text-slate-200/95 text-lg sm:text-xl font-semibold tracking-wide">
          Bienvenido, <span class="text-brand-400">soy Cristian</span> 👋
        </div>
        <div class="text-slate-400 text-xs sm:text-sm">Calcula tus calorías y obtén un plan simple en 3 comidas</div>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="max-w-6xl mx-auto px-4 py-8 min-h-screen">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Entrada -->
      <section class="card p-5 space-y-5" aria-labelledby="datos-title">
        <h2 id="datos-title" class="font-semibold text-lg">Datos</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="sex" class="text-sm text-slate-300">Sexo</label>
            <div class="select-wrap">
              <select id="sex" class="field control">
                <option value="male">Hombre</option>
                <option value="female">Mujer</option>
              </select>
            </div>
          </div>
          <div>
            <label for="age" class="text-sm text-slate-300">Edad (años)</label>
            <input id="age" type="number" min="15" max="75" placeholder="Ingresa tu edad" class="field control" />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="weight" class="text-sm text-slate-300">Peso (kg)</label>
            <input id="weight" type="number" min="35" max="250" placeholder="Peso en kg" class="field control" />
          </div>
          <div>
            <label for="heightCm" class="text-sm text-slate-300">Estatura (cm)</label>
            <input id="heightCm" type="number" min="140" max="220" placeholder="Altura en cm" class="field control" />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="activity" class="text-sm text-slate-300">Nivel de actividad</label>
            <div class="select-wrap">
              <select id="activity" class="field control">
                <option value="1.2">Sedentario (poco o nada)</option>
                <option value="1.375">Ligero (1–3 días/sem)</option>
                <option value="1.55">Moderado (3–5 días/sem)</option>
                <option value="1.725">Activo (6–7 días/sem)</option>
                <option value="1.9">Muy activo (intenso + trabajo físico)</option>
              </select>
            </div>
          </div>
          <div>
            <label for="goal" class="text-sm text-slate-300">Objetivo</label>
            <div class="select-wrap">
              <select id="goal" class="field control">
                <option value="maintain">Mantener</option>
                <option value="cut">Bajar grasa (–10%)</option>
                <option value="bulk">Ganar masa (+10%)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <button id="calcBtn" class="btn btn-primary">Calcular</button>
          <button id="detailsBtn" class="btn">Ver detalles</button>
        </div>

        <p class="text-xs text-slate-300/85">Uso recomendado para adultos sanos. Si tienes condiciones médicas (p. ej., embarazo, riñón), consulta a un profesional de salud.</p>
      </section>

      <!-- Resultados -->
      <section class="card p-5 space-y-5" aria-labelledby="res-title">
        <h2 id="res-title" class="sr-only">Resultados</h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="text-[11px] uppercase tracking-wide text-slate-300/85">Ecuación usada</div>
            <div id="eqUsed" class="text-sm font-medium text-slate-100">Mifflin–St Jeor</div>
          </div>
          <div class="card p-4">
            <div class="text-[11px] uppercase tracking-wide text-slate-300/85">GET mantenimiento (kcal)</div>
            <div id="get" class="text-2xl font-bold text-slate-50">0</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="text-[11px] uppercase tracking-wide text-slate-300/85">TMB (kcal)</div>
            <div id="tmb" class="text-2xl font-bold text-slate-50">0</div>
          </div>
          <div class="card p-4">
            <div class="text-[11px] uppercase tracking-wide text-slate-300/85">Calorías objetivo</div>
            <div id="targetKcal" class="text-2xl font-bold text-slate-50">0</div>
            <div id="adjText" class="text-xs text-slate-300 mt-1">—</div>
          </div>
        </div>

        <div class="card p-4">
          <div class="grid grid-cols-3 gap-3">
            <div class="card p-3">
              <div class="text-slate-200 font-medium">Proteína</div>
              <div id="pGrams" class="text-slate-50 text-lg font-semibold">0 g</div>
              <div id="pInfo" class="text-slate-300 text-xs">—</div>
            </div>
            <div class="card p-3">
              <div class="text-slate-200 font-medium">Grasas</div>
              <div id="fGrams" class="text-slate-50 text-lg font-semibold">0 g</div>
              <div id="fInfo" class="text-slate-300 text-xs">—</div>
            </div>
            <div class="card p-3">
              <div class="text-slate-200 font-medium">Carbohidratos</div>
              <div id="cGrams" class="text-slate-50 text-lg font-semibold">0 g</div>
              <div id="cInfo" class="text-slate-300 text-xs">—</div>
            </div>
          </div>
        </div>

        <details class="text-xs text-slate-300/85 leading-relaxed">
          <summary class="cursor-pointer text-slate-300">Fuentes y notas</summary>
          <ul class="list-disc pl-5 mt-2 space-y-1">
            <li>Mifflin–St Jeor (1990) para TMB; multiplicador de actividad para GET.</li>
            <li>Macros orientativas por kg: Mantener 1.8/0.8 g/kg, Déficit 2.2/0.8 g/kg, Superávit 2.0/1.0 g/kg.</li>
            <li>Ajuste de objetivo estimado: ±10% del mantenimiento.</li>
          </ul>
        </details>
      </section>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 mt-8 text-center text-xs text-slate-300/85">
    © <span id="year"></span> CRISS <span class="text-brand-400">FITT</span> · Herramienta educativa.
  </footer>

  <!-- ===== Modal ===== -->
  <div id="modalBg" class="modal-bg" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modal-header flex items-center justify-between gap-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Detalles</h3>
        <button id="closeModal" class="btn" aria-label="Cerrar">Cerrar</button>
      </div>
      <div id="modalContent" class="modal-body space-y-4 text-base leading-relaxed text-slate-300"></div>
    </div>
  </div>

<!-- ================= LÓGICA ================= -->
<script>
/* ========== Utilidades ========== */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const toNumber=(v,d=0)=>{const n=Number(String(v).replace(",", "."));return Number.isFinite(n)?n:d;}
const round=(n,d=0)=>{const p=10**d;return Math.round(n*p)/p;}

/* ========== Inputs ========== */
const sex=document.getElementById('sex');
const age=document.getElementById('age');
const weight=document.getElementById('weight');
const heightCm=document.getElementById('heightCm');
const activity=document.getElementById('activity');
const goal=document.getElementById('goal');

/* ========== UI ========== */
const calcBtn=document.getElementById('calcBtn');
const detailsBtn=document.getElementById('detailsBtn');

const eqUsed=document.getElementById('eqUsed');
const tmbEl=document.getElementById('tmb');
const getEl=document.getElementById('get');
const targetKcalEl=document.getElementById('targetKcal');
const adjText=document.getElementById('adjText');
const pGrams=document.getElementById('pGrams');
const fGrams=document.getElementById('fGrams');
const cGrams=document.getElementById('cGrams');
const pInfo=document.getElementById('pInfo');
const fInfo=document.getElementById('fInfo');
const cInfo=document.getElementById('cInfo');

/* ========== Modal ========== */
const modalBg=document.getElementById('modalBg');
const modalTitle=document.getElementById('modalTitle');
const modalContent=document.getElementById('modalContent');
const closeModal=document.getElementById('closeModal');

/* ========== Helpers ========= */
function weightKg(){return clamp(toNumber(weight.value,0), 35, 250);}
function heightCmVal(){return clamp(toNumber(heightCm.value,0), 140, 220);}

/* Split entero que suma exacto */
function splitEven(total, parts){
  const base = Math.floor(total/parts);
  const arr  = Array(parts).fill(base);
  let rem = total - base*parts;
  for(let i=0; i<parts && rem>0; i++){ arr[i]+=1; rem--; }
  return arr;
}

/* ========== Cálculos base ========== */
function calcTMB(){
  const a=clamp(toNumber(age.value,0), 15, 75);
  const w=weightKg();
  const h=heightCmVal();
  eqUsed.textContent='Mifflin–St Jeor';
  return Math.max(0, 10*w + 6.25*h - 5*a + (sex.value==='male'?5:-161));
}
function calcGET(tmb){return tmb * toNumber(activity.value,1.2);} // por defecto: primera opción

function macrosByGoal(g){
  if(g==='cut')  return {pPerKg:2.2, fPerKg:0.8, adj:-0.10, label:'Déficit 10%'};
  if(g==='bulk') return {pPerKg:2.0, fPerKg:1.0, adj:+0.10, label:'Superávit 10%'};
  return {pPerKg:1.8, fPerKg:0.8, adj:0.0, label:'Mantener (0%)'};
}

/* ========== Bloques / platos de ejemplo (texto) ========== */
function blocksGuideHTML(){
  return `
  <div class="panel-base panel-black">
    <h4 class="font-semibold text-slate-100">Bloques de alimentos (guía rápida)</h4>
    <div class="grid md:grid-cols-3 gap-4 mt-3">
      <div>
        <div class="text-slate-200 font-semibold mb-1">Carbo (~25 g C)</div>
        <ul class="list-disc pl-5 text-slate-300 text-sm space-y-1">
          <li>Arroz cocido 85–90 g ≈ 25 C</li>
          <li>Camote cocido 150 g ≈ 30 C</li>
          <li>Avena seca 40 g ≈ 27 C</li>
          <li>Plátano 1 mediano ≈ 27 C</li>
          <li>Pan 2 rebanadas (60 g) ≈ 30 C</li>
          <li>Yuca cocida 120 g ≈ 30 C</li>
        </ul>
      </div>
      <div>
        <div class="text-slate-200 font-semibold mb-1">Proteína (~20 g P)</div>
        <ul class="list-disc pl-5 text-slate-300 text-sm space-y-1">
          <li>Pechuga pollo 100 g ≈ 23–30 P</li>
          <li>Atún en agua (1 lata) ≈ 28 P</li>
          <li>Yogur griego 200 g ≈ 20 P</li>
          <li>Claras 5 u ≈ 18 P</li>
          <li>Res magra 100 g ≈ 23 P</li>
        </ul>
      </div>
      <div>
        <div class="text-slate-200 font-semibold mb-1">Grasa (~10 g G)</div>
        <ul class="list-disc pl-5 text-slate-300 text-sm space-y-1">
          <li>Aceite oliva 1 cda (15 ml) ≈ 14 G</li>
          <li>Aguacate 70–80 g ≈ 10–12 G</li>
          <li>Maní 15 g ≈ 8 G</li>
          <li>Yema 1 u ≈ 5 G</li>
        </ul>
      </div>
    </div>
  </div>`;
}

/* NUEVO: Menús reales (desayuno/almuerzo/cena) basados en bloques */
function realMenusHTML(meals3){
  const nombres = ["Desayuno", "Almuerzo", "Cena"];
  const cards = meals3.map((m,i)=>{
    const cBlocks = Math.max(1, Math.round(m.c/25));
    const pBlocks = Math.max(1, Math.round(m.p/20));
    const fBlocks = Math.max(1, Math.round(m.f/10));
    const ejemplo1 = `
      • Carbo (${cBlocks} bloques): arroz cocido (~90 g x ${cBlocks})<br/>
      • Proteína (${pBlocks} bloques): pechuga pollo 80–120 g + yogur/claras hasta completar<br/>
      • Grasa (${fBlocks} bloques): aceite oliva 1 cda ≈ 1 bloque, o aguacate 70–80 g`;
    const ejemplo2 = `
      • Carbo (${cBlocks} bloques): camote/yuca (~120–150 g por bloque), fruta si falta<br/>
      • Proteína (${pBlocks} bloques): atún (1 lata ≈ 1–1.5 bloques) + claras<br/>
      • Grasa (${fBlocks} bloques): maní 15 g ≈ 0.8 bloque · ajusta con aceite`;
    return `
      <div class="panel-base panel-black">
        <div class="font-semibold text-slate-100">${nombres[i]} · objetivo ≈ ${m.kcal} kcal</div>
        <div class="text-sm text-slate-300 mt-1">Elige: <b>${cBlocks}</b> bloques de carbo · <b>${pBlocks}</b> de proteína · <b>${fBlocks}</b> de grasa.</div>
        <div class="text-xs text-slate-400 mt-2">1 bloque: 25 g C · 20 g P · 10 g G.</div>
        <div class="mt-3 text-sm space-y-2">
          <div><span class="text-slate-200 font-medium">Ejemplo A:</span><br/>${ejemplo1}</div>
          <div><span class="text-slate-200 font-medium">Ejemplo B:</span><br/>${ejemplo2}</div>
        </div>
        <div class="text-xs text-slate-400 mt-2">Tip: mueve más carbos alrededor del entrenamiento.</div>
      </div>`;
  }).join('');
  return `<h4 class="font-semibold text-slate-100 mt-4">Tres menús reales (listos para usar)</h4>
          <div class="grid md:grid-cols-3 gap-4">${cards}</div>`;
}

function examplePlatesHTML(mealTargets){
  const cards = mealTargets.map((m,i)=>`
    <div class="panel-base panel-black">
      <div class="font-semibold text-slate-100 mb-1">Comida ${i+1} · objetivo ≈ ${m.kcal} kcal</div>
      <ul class="list-disc pl-5 text-slate-300 text-sm space-y-1">
        <li>Carbos base: combina 3–4 bloques (arroz/camote/avena/fruta) ≈ ${m.c} g C</li>
        <li>Proteína: 2 bloques (pollo/atún/yogur) ≈ ${m.p} g P</li>
        <li>Grasa: 1–2 bloques (aceite/aguacate) ≈ ${m.f} g G</li>
      </ul>
      <div class="text-xs text-slate-400 mt-2">Mueve más carbos si entrenas justo antes/después.</div>
    </div>`).join('');
  return `<div class="grid md:grid-cols-3 gap-4">${cards}</div>`;
}

/* Texto del modal */
function renderDetails(plan){
  const {label, target, pG, fG, cG, meals3, weeklyText, safetyMsgs} = plan;

  const daily =
    `<div class="panel-base panel-black">
      <p><b>Tu objetivo diario:</b> <b>${Math.round(target)} kcal</b> (${label.toLowerCase()}).</p>
      <p><b>Macros diarios exactos:</b> <b>${Math.round(pG)} g proteína</b> · <b>${Math.round(fG)} g grasa</b> · <b>${Math.round(cG)} g carbohidratos</b>.</p>
      <p><b>Plan en 3 comidas (exacto):</b> tabla siguiente.</p>
      ${safetyMsgs.length? `<div class="text-xs text-amber-300/90 mt-2">${safetyMsgs.map(m=>`<div>${m}</div>`).join('')}</div>`:''}
      <div class="text-slate-400 text-sm mt-2">${weeklyText}</div>
    </div>`;

  const rows = meals3.map((m,i)=>`
    <tr class="hover:bg-white/5">
      <td class="rounded-l-lg">Comida ${i+1}</td>
      <td>${m.kcal}</td>
      <td>${m.p} g</td>
      <td>${m.f} g</td>
      <td class="rounded-r-lg">${m.c} g</td>
    </tr>`).join('');

  const table =
    `<div class="panel-base panel-black">
      <h4 class="font-semibold text-slate-100 mb-2">Distribución exacta (3 comidas)</h4>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Comida</th><th>Kcal</th><th>Proteína</th><th>Grasa</th><th>Carbohidratos</th>
            </tr>
          </thead>
          <tbody class="text-slate-200">${rows}</tbody>
        </table>
      </div>
      <div class="text-xs text-slate-400 mt-2">La suma de las 3 comidas coincide EXACTO con tu objetivo diario.</div>
    </div>`;

  /* ORDEN final en el modal: resumen -> tabla -> bloques -> ideas por comida -> NUEVOS menús reales */
  return `${daily}
          ${table}
          ${blocksGuideHTML()}
          <h4 class="font-semibold text-slate-100 mt-4">Ideas de platos por comida</h4>
          ${examplePlatesHTML(meals3)}
          ${realMenusHTML(meals3)}`;
}

/* ========== Cálculo principal ========== */
function compute(){
  const TMB=calcTMB();
  const GET=calcGET(TMB);
  const {pPerKg,fPerKg,adj,label}=macrosByGoal(goal.value);
  const target = GET*(1+adj);

  const kg = weightKg();

  // Macros base
  let pG = kg * pPerKg;
  let fG = kg * fPerKg;

  // Buenas prácticas
  const pMin = 1.6 * kg, pMax = 2.4 * kg;
  pG = clamp(pG, pMin, pMax);
  const minFatByPct = (target * 0.20) / 9;
  const minFatByKg  = 0.6 * kg;
  fG = Math.max(fG, minFatByPct, minFatByKg);

  // Carbo residual
  let kcalP = pG*4, kcalF = fG*9;
  let cG = (target - (kcalP + kcalF))/4;

  // Si carbs negativos, baja proteína hacia 1.6 g/kg
  if (cG < 0){
    const kcalDef = -cG*4;
    const reducibleProt = pG - pMin;
    const pDrop = Math.min(reducibleProt, kcalDef/4);
    pG -= Math.max(0, pDrop);
    kcalP = pG*4;
    cG = (target - (kcalP + kcalF))/4;
  }

  // Redondeo a enteros
  const totalKcal = Math.round(target);
  const totalP = Math.round(pG);
  const totalF = Math.round(fG);
  const totalC = Math.round(cG);

  // Alertas
  const safetyMsgs=[];
  if(target < TMB) safetyMsgs.push('⚠️ Objetivo por debajo de tu TMB. Sube calorías.');
  const fatPct = ((totalF*9)/(totalKcal||1))*100;
  if(fatPct < 20) safetyMsgs.push('ℹ️ La grasa queda < 20% de las kcal. Sube un poco.');
  if(totalC <= 0) safetyMsgs.push('⚠️ Carbohidratos ≈ 0 g. Ajusta macros o kcal.');

  // Tarjetas
  tmbEl.textContent=round(TMB);
  getEl.textContent=round(GET);
  targetKcalEl.textContent=totalKcal;
  adjText.textContent=`${label}. Mantenimiento ${round(GET)} kcal → objetivo ${totalKcal} kcal/día.`;
  pGrams.textContent=`${totalP} g`;  fGrams.textContent=`${totalF} g`;  cGrams.textContent=`${totalC} g`;
  const kgSafe = Math.max(kg,1);
  pInfo.textContent=`${(totalP/kgSafe).toFixed(2)} g/kg × ${round(kg)} kg = ${totalP} g`;
  fInfo.textContent=`${(totalF/kgSafe).toFixed(2)} g/kg × ${round(kg)} kg = ${totalF} g`;
  cInfo.textContent=`(Objetivo − proteínas − grasas) ÷ 4`;

  // Estimado semanal
  const delta = totalKcal - Math.round(GET);
  const weeklyKg = (delta*7)/7700;
  const pctBody = (weeklyKg/Math.max(kg,1))*100;
  const weeklyText = (goal.value==='maintain')
    ? 'Mantenimiento: cambios de peso pequeños son normales.'
    : `Estimado de cambio: ${weeklyKg>=0?'+':''}${round(weeklyKg,2)} kg/sem (≈ ${round(pctBody,2)}%/sem). Recomendado: 0.25–0.5%/sem.`;

  /* Plan EXACTO en 3 comidas */
  const meals3 = (()=>{
    const kcal = splitEven(totalKcal, 3);
    let p = splitEven(totalP, 3);
    let f = splitEven(totalF, 3);
    let c = splitEven(totalC, 3);

    for(let i=0;i<3;i++){
      let kcalNow = 4*p[i] + 9*f[i] + 4*c[i];
      while(kcalNow !== kcal[i]){
        if(kcalNow < kcal[i]){
          if(kcal[i] - kcalNow >= 4){ c[i] += 1; }
          else { f[i] += 1; c[i] = Math.max(0, c[i]-2); }
        }else{
          if(kcalNow - kcal[i] >= 4 && c[i] > 0){ c[i] -= 1; }
          else if(f[i] > 0){ f[i] -= 1; c[i] += 2; }
          else if(p[i] > 0){ p[i] -= 1; }
        }
        kcalNow = 4*p[i] + 9*f[i] + 4*c[i];
      }
    }
    return [{kcal:kcal[0], p:p[0], f:f[0], c:c[0]},
            {kcal:kcal[1], p:p[1], f:f[1], c:c[1]},
            {kcal:kcal[2], p:p[2], f:f[2], c:c[2]}];
  })();

  window.__plan = {label, target: totalKcal, pG: totalP, fG: totalF, cG: totalC, meals3, weeklyText, safetyMsgs};
}

/* ========== Modal helpers ========== */
function openModal(title, html){
  modalTitle.textContent = title;
  modalContent.innerHTML = html;
  modalBg.classList.add('open');
  modalBg.setAttribute('aria-hidden','false');
}
function closeModalFn(){ modalBg.classList.remove('open'); modalBg.setAttribute('aria-hidden','true'); }

/* ========== Init ========== */
document.getElementById('year').textContent=new Date().getFullYear();
calcBtn.addEventListener('click', compute);
detailsBtn.addEventListener('click', ()=>{
  if(!window.__plan) compute();
  openModal('Cómo usar tu plan', renderDetails(window.__plan));
});
closeModal.addEventListener('click', closeModalFn);
modalBg.addEventListener('click', (e)=>{ if(e.target===modalBg) closeModalFn(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModalFn(); });

// Sin cálculo inicial: el formulario arranca limpio.
</script>
</body>
</html>
